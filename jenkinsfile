pipeline {
    agent any

    environment {
        CMD = 'C:\\Windows\\System32\\cmd.exe'
        PM2_CMD = 'C:\\Users\\vovab\\node_modules\\.bin\\pm2.cmd'
        PYTHON_EXE = 'C:\\Users\\vovab\\AppData\\Local\\Programs\\Python\\Python312\\python.exe'
        TARGET_DIR = 'C:\\Users\\vovab\\Desktop\\Флешка\\4 курс (1 семестр)\\Основы DevOps\\DevOps_LAB1\\Django01_server'
    }

    triggers { 
        githubPush() 
    }

    stages {
        stage('Pull Latest Changes') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN'),
                    string(credentialsId: 'github-email', variable: 'GIT_EMAIL')
                ]) {
                    bat """
                        cd "${TARGET_DIR}"

                        :: Настройка git
                        git config user.name "%GIT_USER%"
                        git config user.email "%GIT_EMAIL%"

                        :: Получение всех веток
                        git fetch --all
                        
                        :: Переключаемся на ветку fix

                        git checkout fix
                        :: Обновление локальной ветки fix
                        git pull https://%GIT_USER%:%GIT_TOKEN%@github.com/VladimirBogd/Django01.git fix

                        :: Показываем текущее состояние
                        echo "Current directory:"
                        cd
                        echo "Git status:"
                        git status
                        echo "Latest commit:"
                        git log -1 --oneline
                    """
                }
            }
        }
        stage('Restart Servers') {
            steps {
                bat """
                    cd "${TARGET_DIR}"

                    :: Останавливаем все процессы PM2
                    call "${PM2_CMD}" restart ecosystem.config.js

                    :: Ждем немного для стабилизации процессов
                    ping -n 10 127.0.0.1 > nul
                    
                    :: Проверяем статус всех процессов
                    echo Current PM2 status:
                    call "${PM2_CMD}" list
                    
                    :: Проверяем логи Vue приложения (первые 10 строк)
                    echo Vue app logs:
                    call "${PM2_CMD}" logs vue --lines 10 --nostream
                    
                    :: Проверяем логи Django приложения (первые 10 строк)
                    echo Django app logs:
                    call "${PM2_CMD}" logs django --lines 10 --nostream
                """
            }
        }
        stage('Run Tests') {
            steps {
                script {
                    try {
                        bat """
                            cd "${TARGET_DIR}"
                            "${PYTHON_EXE}" manage.py test wizards.tests
                        """
                        echo "Tests passed! Keeping servers running."
                    } catch (err) {
                        echo "Tests failed! Stopping servers..."

                        bat """
                            cd "${TARGET_DIR}"
                            "${PM2_CMD}" stop ecosystem.config.js
                        """
                        error("Integration tests failed. Servers stopped.")
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline execution completed"
            bat """
                echo Final PM2 status:
                "${PM2_CMD}" list
            """
        }
        failure {
            script {
                echo "Performing rollback due to pipeline failure..."
                bat """
                    cd "${TARGET_DIR}"
                    git fetch --all

                    :: Откатываемся к коммиту перед последним пушем
                    git reset --hard origin/fix

                    call "${PM2_CMD}" restart ecosystem.config.js
                """
            }
        }
        success {
            echo "Backend and Frontend are running via PM2!"
            echo "Backend: http://127.0.0.1:8000/"
            echo "Frontend: http://127.0.0.1:5173/"
        }
    }
}